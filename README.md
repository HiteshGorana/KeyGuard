# Access Key Management and Token Information Retrieval System

## Overview

This project consists of two microservices developed using NestJS, designed to manage access keys and retrieve token information. The microservices communicate via Redis Pub/Sub for event streaming.

## Microservice 1: Access Key Management Service

### Objective

This service is responsible for generating access keys for users, defining rate limits, expiration times, and providing administrative capabilities to create or delete keys. Users can retrieve their plan details using their key.

### Core Features

- **Key Generation**: Allows admins to generate access keys for users, specifying request rate limits per minute and key expiration time.
- **Admin Commands**: Simple commands for administrators to create, delete, and list keys. Also, functionality to update the rate limit or expiration of existing keys.
- **User Queries**: Enables users to fetch the details of their access plan (rate limit, expiration, etc.) by making an API call with their key and disable the key.

### Endpoints

- **Create Access Key**: `POST /admin/access-keys`
- **Delete Access Key**: `DELETE /admin/access-keys/:key`
- **List All Access Keys**: `GET /admin/access-keys`
- **Update Access Key**: `PATCH /admin/access-keys/:key`
- **Get Access Key Details**: `GET /access-keys/:key`
- **Disable Access Key**: `PATCH /access-keys/:key/disable`

## Microservice 2: Token Information Service

### Objective

This service allows users to fetch token information based on their access keys. It respects the rate limits and expiration times defined in the keys generated by Microservice 1.

### Core Features

- **Token Information Retrieval**: Provides an endpoint to fetch token information. The response should be a mock or static data, as the focus is on access control rather than the data itself.
- **Rate Limit Enforcement**: Checks the user’s request rate against their key’s rate limit. If the rate is exceeded, it returns an error response.
- **Key Validation**: Verifies if the key is valid and has not expired before allowing access to the token information.
- **Logging**: Optionally, logs each request for token information, including key used, timestamp, and whether the request was successful or rate-limited.

### Endpoints

- **Get Token Info**: `GET /token-info`

## Technologies

- **NestJS**: Primary framework for developing both microservices.
- **Redis**: Used for caching and Pub/Sub communication between microservices.
- **MongoDB**: Used for persistent storage of access keys.

## Installation and Running

### Prerequisites

- Docker
- Node.js
- npm

### Setup

1. **Clone the repository**

   ```sh
   git clone <repository_url>
   cd <repository_directory>
   ```

2. **Start the services**

   ```sh
   docker compose up --build
   npm run start:dev access-key
   npm run start:dev token
   ```

3. **Run Tests**
   ```sh
   npm run test:e2e
   ```

### Postman Collection

A Postman collection is provided for testing the endpoints. Import the `Access Key Management Service.postman_collection.json` file into Postman.

### Access Key Management Service

- **Create Access Key**

  ```json
  POST http://localhost:3000/admin/access-keys
  Body:
  {
      "rateLimit": 100,
      "expiresInMs": 3600000
  }
  ```

- **Delete Access Key**

  ```json
  DELETE http://localhost:3000/admin/access-keys/:key
  ```

- **List All Access Keys**

  ```json
  GET http://localhost:3000/admin/access-keys
  ```

- **Update Access Key**

  ```json
  PATCH http://localhost:3000/admin/access-keys/:key
  Body:
  {
      "rateLimit": 150,
      "expiresInMs": 7200000,
      "isDisabled": false
  }
  ```

- **Get Access Key Details**

  ```json
  GET http://localhost:3000/access-keys/:key
  ```

- **Disable Access Key**
  ```json
  PATCH http://localhost:3000/access-keys/:key/disable
  ```

### Token Information Service

- **Get Token Info**
  ```json
  GET http://localhost:3000/token-info?key=<your_access_key>
  ```

## Source Code Structure

```
KEYGUARD
│
├── apps
│   ├── access-key
│   │   ├── src
│   │   │   ├── dto
│   │   │   │   └── update-access-key.dto.ts
│   │   │   ├── schemas
│   │   │   │   └── access-key.schema.ts
│   │   │   ├── services
│   │   │   ├── access-key.module.ts
│   │   │   └── main.ts
│   │   ├── test
│   │   │   ├── app.e2e-spec.ts
│   │   │   ├── jest-e2e.json
│   │   │   └── tsconfig.app.json
│   ├── token
│   │   ├── src
│   │   │   ├── controllers
│   │   │   │   └── token.controller.ts
│   │   │   ├── schemas
│   │   │   │   └── access-key.schema.ts
│   │   │   ├── services
│   │   │   └── main.ts
│   │   ├── test
│   │   │   ├── app.e2e-spec.ts
│   │   │   ├── jest-e2e.json
│   │   │   └── tsconfig.app.json
├── dist
├── node_modules
├── .env
├── .env.example
├── .eslintrc.js
├── .gitignore
└── prettierrc
```

### Bonus

- Tests are implemented using Jest for end-to-end testing.
